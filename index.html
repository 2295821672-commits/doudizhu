<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¬¢ä¹äº”äººæš—å“¨å±€-ç»ˆæäº¤ä»˜ç‰ˆ</title>
    <style>
        /* æ¬¢ä¹æ–—åœ°ä¸»ç»å…¸è§†è§‰ */
        body { background: radial-gradient(circle, #2e7d32 0%, #1b5e20 100%); color: white; margin: 0; font-family: sans-serif; overflow: hidden; }
        .status-bar { background: rgba(0,0,0,0.5); padding: 10px; font-size: 14px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); }
        
        /* æ¡Œé¢å¸ƒå±€ */
        #table-center { position: absolute; top: 38%; left: 50%; transform: translate(-50%, -50%); width: 85%; height: 160px; display: flex; justify-content: center; align-items: center; border: 2px dashed rgba(255,255,255,0.15); border-radius: 20px; z-index: 1; }
        #timer-box { position: absolute; top: 22%; left: 50%; transform: translateX(-50%); background: #ffeb3b; border: 3px solid #5d4037; border-radius: 50%; width: 42px; height: 42px; line-height: 42px; text-align: center; color: #5d4037; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.5); z-index: 10; }

        /* ç”µè„‘ç©å®¶ */
        .robot { position: absolute; background: rgba(0,0,0,0.6); padding: 6px 12px; border-radius: 12px; font-size: 12px; color: #eee; border: 1px solid rgba(255,255,255,0.2); }
        .r1 { top: 50%; left: 2%; } .r2 { top: 12%; left: 15%; } .r3 { top: 12%; right: 15%; } .r4 { top: 50%; right: 2%; }

        /* æ“ä½œæŒ‰é’® */
        .controls { position: fixed; bottom: 175px; width: 100%; text-align: center; z-index: 100; }
        .btn { padding: 10px 32px; border-radius: 25px; border: 2px solid #fff; font-weight: bold; font-size: 18px; margin: 0 10px; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.1s; }
        .btn-pass { background: linear-gradient(to bottom, #757575, #424242); color: white; }
        .btn-play { background: linear-gradient(to bottom, #ffeb3b, #fbc02d); color: #5d4037; }
        .btn:active { transform: translateY(2px); box-shadow: none; }

        /* ç›´çº¿ç´§å‡‘æ‰‹ç‰Œ */
        .hand-area { display: flex; justify-content: center; position: fixed; bottom: 20px; width: 100%; height: 130px; z-index: 50; }
        .card { width: 66px; height: 96px; background: white; border-radius: 8px; color: black; margin-left: -48px; border: 1px solid #999; position: relative; transition: 0.2s; box-shadow: -2px 2px 6px rgba(0,0,0,0.4); padding: 5px; cursor: pointer; }
        .card:first-child { margin-left: 0; }
        .card.selected { transform: translateY(-30px); border: 2px solid #ff9800; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .rank { font-size: 24px; font-weight: bold; }
        
        /* æ¡Œé¢å‡ºç‰Œæ ·å¼ */
        .played-card { width: 55px; height: 80px; background: #fff; border-radius: 6px; color: black; margin: 0 3px; border: 1px solid #ddd; text-align: center; line-height: 80px; font-weight: bold; font-size: 20px; box-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div class="status-bar">
        <span id="status-text">æ­£åœ¨åŠ è½½...</span>
        <button onclick="toggleMode()" style="background:#0277bd;color:white;border:none;padding:3px 10px;border-radius:10px;">åˆ‡æ¢è”ç½‘</button>
    </div>

    <div class="robot r1" id="robot1-txt">ğŸ¤– ç”µè„‘1 (21)</div>
    <div class="robot r2" id="robot2-txt">ğŸ¤– ç”µè„‘2 (21)</div>
    <div class="robot r3" id="robot3-txt">ğŸ¤– ç”µè„‘3 (21)</div>
    <div class="robot r4" id="robot4-txt">ğŸ¤– ç”µè„‘4 (21)</div>

    <div id="table-center"></div>
    <div id="timer-box">120</div>

    <div class="controls" id="control-layer">
        <button class="btn btn-pass" onclick="handlePass()">ä¸å‡º</button>
        <button class="btn btn-play" onclick="handlePlay()">å‡ºç‰Œ</button>
    </div>

    <div class="hand-area" id="player-hand"></div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let myHand = [];
        let isOnline = false;
        let timeLeft = 120;
        let lastPlay = { type: null, rank: 0, count: 0 };
        let socket = null;

        // --- æ ¸å¿ƒï¼šç‰Œå‹é€»è¾‘ç®—æ³• ---
        function getCardType(cards) {
            cards.sort((a,b) => a.rank - b.rank);
            const len = cards.length;
            if (len === 1) return { type: 'SINGLE', rank: cards[0].rank, count: 1 };
            if (len === 2 && cards[0].rank === cards[1].rank) return { type: 'PAIR', rank: cards[0].rank, count: 2 };
            if (len === 4 && cards.every(c => c.rank === cards[0].rank)) return { type: 'BOMB', rank: cards[0].rank, count: 4 };
            // ç¦æ­¢ä¸‰å¸¦ä¸‰é€»è¾‘ï¼šå¦‚æœé•¿åº¦ä¸º6ä¸”æœ‰ä¸‰å¼ ä¸€æ ·çš„ï¼Œç›´æ¥è¿”å›null
            return null; 
        }

        // --- æ ¸å¿ƒï¼šAI å‡ºç‰Œæµç¨‹ ---
        async function runAILoop() {
            document.getElementById('control-layer').style.visibility = 'hidden';
            let passedCount = 0;

            for (let i = 1; i <= 4; i++) {
                document.getElementById('status-text').innerText = `ç”µè„‘ ${i} æ­£åœ¨å†³ç­–...`;
                await new Promise(r => setTimeout(r, 1100));
                
                let play = null;
                // ç®€å•çš„AIæ¨¡æ‹Ÿæ¯”å¤§å°é€»è¾‘
                if (lastPlay.type === null || Math.random() > 0.7) {
                    play = { type: lastPlay.type || 'SINGLE', rank: (lastPlay.rank || 2) + 1, count: lastPlay.count || 1 };
                    if (play.rank > 15) play = null; // AIæ²¡æœ‰2ä»¥ä¸Šçš„ç‰Œäº†
                }

                if (play) {
                    const aiCards = Array(play.count).fill({rank: play.rank});
                    renderTable(aiCards);
                    lastPlay = { type: play.type, rank: play.rank, count: play.count };
                    document.getElementById(`robot${i}-txt`).innerText = `ğŸ¤– ç”µè„‘${i} (ç®¡ä¸Š)`;
                    passedCount = 0; // é‡ç½®è¿‡ç‰Œè®¡æ•°
                    // åªè¦æœ‰äººç®¡ä¸Šï¼Œå°±ç»§ç»­ä¸‹ä¸€ä½AIæˆ–ç©å®¶
                } else {
                    document.getElementById(`robot${i}-txt`).innerText = `ğŸ¤– ç”µè„‘${i} (ä¸è¦)`;
                    passedCount++;
                }
            }

            if(passedCount >= 4) {
                lastPlay = { type: null, rank: 0, count: 0 };
                document.getElementById('status-text').innerText = "å¤§å®¶éƒ½ä¸è¦ï¼Œè¯¥ä½ å‡ºç‰Œï¼";
            } else {
                document.getElementById('status-text').innerText = "è½®åˆ°ä½ äº†";
            }
            
            document.getElementById('control-layer').style.visibility = 'visible';
            timeLeft = 120;
        }

        // --- äº¤äº’åŠŸèƒ½ ---
        function handlePlay() {
            const selected = myHand.filter(c => c.selected);
            const result = getCardType(selected);

            if (!result) return alert("ç‰Œå‹é”™è¯¯æˆ–ç¦æ­¢ä¸‰å¸¦ä¸‰ï¼");
            if (lastPlay.type && (result.type !== lastPlay.type || result.rank <= lastPlay.rank)) {
                if(result.type !== 'BOMB') return alert("ç‰Œä¸å¤Ÿå¤§ï¼");
            }

            lastPlay = result;
            renderTable(selected);
            myHand = myHand.filter(c => !c.selected);
            renderHand();
            runAILoop();
        }

        function handlePass() {
            document.getElementById('table-center').innerHTML = '<span style="color:#aaa">ä¸å‡º</span>';
            runAILoop();
        }

        function renderTable(cards) {
            const center = document.getElementById('table-center');
            center.innerHTML = '';
            cards.forEach(c => {
                const div = document.createElement('div');
                div.className = 'played-card';
                div.innerText = getRankName(c.rank);
                center.appendChild(div);
            });
        }

        function renderHand() {
            const container = document.getElementById('player-hand');
            container.innerHTML = '';
            myHand.forEach(card => {
                const div = document.createElement('div');
                div.className = 'card' + (card.selected ? ' selected' : '');
                div.innerHTML = `<span class="rank">${getRankName(card.rank)}</span>`;
                div.onclick = () => { card.selected = !card.selected; renderHand(); };
                container.appendChild(div);
            });
        }

        function getRankName(r) {
            const n = {11:'J', 12:'Q', 13:'K', 14:'A', 15:'2', 16:'å°', 17:'å¤§'};
            return n[r] || r;
        }

        function startOffline() {
            isOnline = false;
            document.getElementById('status-text').innerText = "å•æœºæ¨¡å¼ï¼šå·²å‘ç‰Œ";
            let deck = [];
            for(let r=3; r<=17; r++) {
                let count = (r<16)?8:2; // ä¸¤å‰¯ç‰Œé€»è¾‘
                for(let c=0; c<count; c++) deck.push({rank: r});
            }
            deck.sort(() => Math.random() - 0.5);
            myHand = deck.slice(0, 21).sort((a,b) => b.rank - a.rank);
            renderHand();
        }

        function toggleMode() { alert("æ­£åœ¨è¿æ¥ Zeabur è”ç½‘å¤§è„‘..."); }

        window.onload = startOffline;
        setInterval(() => { if(timeLeft > 0) { timeLeft--; document.getElementById('timer-box').innerText = timeLeft; } }, 1000);
    </script>
</body>
</html>
